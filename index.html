<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    
    <title>yassinm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta property="og:type" content="website">
<meta property="og:title" content="yassinm">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="yassinm">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yassinm">
    

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">yassinm</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">Home</a>
                
                    <a class="main-nav-link" href="/archives">Archives</a>
                
                    <a class="main-nav-link" href="/about">About</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/M-Cyk09B_400x400.jpg" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">Home</a></td>
                
                    <td><a class="main-nav-link" href="/archives">Archives</a></td>
                
                    <td><a class="main-nav-link" href="/about">About</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="Search" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/M-Cyk09B_400x400.jpg" />
            <h2 id="name">Yassin Mohamed</h2>
            <h3 id="title">Father , Husband</h3>
            <span id="location"><i class="fa fa-map-marker"></i>Ottawa, Canada</span>
            <a id="follow" target="_blank" href="https://twitter.com/yassinm_tw">FOLLOW</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                6
                <span>posts</span>
            </div>
            <div class="article-info-block">
                3
                <span>tags</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/yassinm" target="_blank" title="github" class=tooltip>
                            <i class="fa fa-github"></i>
                        </a>
                    </td>
                    
                    <td>
                        <a href="https://twitter.com/yassinm_tw" target="_blank" title="twitter" class=tooltip>
                            <i class="fa fa-twitter"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main">
    <article id="post-2017/wiring-data-transformations-for-speed-02" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/10/09/2017/wiring-data-transformations-for-speed-02/">Wiring data transformations for speed (part 2)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/10/09/2017/wiring-data-transformations-for-speed-02/">
            <time datetime="2017-09-10T15:00:00.000Z" itemprop="datePublished">2017-09-10</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/data-flow/">data flow</a>, <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/memory/">memory</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>If you remember our previous <a href="/07/09/2017/wiring-data-transformations-for-speed-01">article</a> we highlighted some of the inherent complexities we introduce by writing code the way we do today. We also stopped at a very few high level because frankly speaking this was going to be a very long read if we did not stop ranting about the current state of affairs :((</p>
<p>In that article, we came to the conclusion that maybe we needed a way to remove those unnecessary complexities and deal with them outside the data flow graph to achieve maximum flexibility and speed. As the famous quote goes:</p>
<blockquote>
<p>Perfection is achieved, not when there is nothing more to add, but when there is nothing left to take away.  <em>Antoine de Saint-Exupéry</em>, <strong>Airman’s Odyssey</strong></p>
</blockquote>
<p>In this article we will try to address <code>why</code> removing those <em>pesky details</em> from our data transformations can not only simplify our development life greatly but also open the door to more optimizations. We want to show <code>what</code> can be achieved by deferring those concerns and <code>what</code> kind of performance can bolted on the system at a later stage because of the simplifications we introduced in our system.</p>
<h2 id="Show-me-the-data-flow"><a href="#Show-me-the-data-flow" class="headerlink" title="Show me the data (flow) !"></a>Show me the data (flow) !</h2><p>Going back to our previous <a href="/07/09/2017/wiring-data-transformations-for-speed-01">article</a> here is the graph we were dealing with:</p>
<img src="/images/wiring-data-transformations-for-speed-001.png">
<p>The <code>multiply</code> method takes two arguments here as input and produces one output. The <code>add</code> method also takes two arguments and produces one output.</p>
<p>The first important thing we are going to do is to stop calling our arguments (be it for input or output) as data. The idea here is that we want to focus wiring data for transformations only and only deal with defining the flow graph of how data is converted. If we take the above graph and only concentrate on the data transformations paths we can , for example, rearrange and draw it like this:</p>
<img src="/images/wiring-data-transformations-for-speed-002.png" width="400">
<p>This is not necessarily a major departure from what we had before . There is still a subtle difference that will allow us to surface the underlying data transformation stages in a more meaningful way.</p>
<p>We want to reduce data transformations to this absolute simple world of data converted to other data. Data is <em>the</em> central point of focus in our approach as opposed to transformations. Transformations are also central to this landscape, however, since they are not particularly <em>indulged</em> with state they can be <em>simplified</em> or just <em>ignored</em>. Well … At least for now !</p>
<p>We all had to deal with state in a very explicit and error prone fashion. Not only handling state but always <em>knowing</em> about and dealing with what happens to that state in the life cycle of the application. Meaning, all parts of our business logic had to know about and care about this state. Part of our transformation strategy above is the fact that we refuse to deal with what happens to that state outside our transformation. Our transformations all deal with a particular data as input and only care about generating the next output from that data. But above and beyond that it should not be concerned with what happens to that data afterwards !</p>
<p>If the above is starting to sound like the same ideas championed by the functional programming world as <a href="https://www.youtube.com/watch?v=eis11j_iGMs" target="_blank" rel="external">lambda calculus</a> it is actually intentional. The idea here to strip all our data transformations from unnecessary concerns. We want to get each function to its bare minimum so that we can think about them as <a href="https://en.wikipedia.org/wiki/Pure_function" target="_blank" rel="external">pure functions</a>. </p>
<p>The payoff of this approach is that we can introduce three things in our transformations. Namely:</p>
<ul>
<li>data ownership and control </li>
<li>data storage</li>
<li>data transports </li>
</ul>
<h2 id="Injecting-data-ownership"><a href="#Injecting-data-ownership" class="headerlink" title="Injecting data ownership !"></a>Injecting data ownership !</h2><p>We decided that our transformations are not preoccupied with what happens to the data once it leaves a particular transformation. As a direct consequence we can <em>infer</em> data ownership based solely on that invariant. The run time is then free to decide and assign ownership to that data or manage it as it so pleased. It can even assign ownership in a temporal and short lived fashion. The sky is the limit here in what kind of games we can play for the sake of performance !</p>
<p>Just imagine a world where you do not have to think twice not only about data ownership but also dealing with the constant concerns relating to concurrency and multiple read/write controls. You heard that right ! So far no one owns that data for a reason ! The run time basically hands this data to a transformation and says here do what want with it and please do not be worried about anyone else touching this data while you are mocking with it. I will not only handle the concurrency issues but i (as the run time and chief scheduling executive) will also make sure that this data is freed when it is no longer needed ! If you are thinking garbage collection then you are on the right track again. But we are actually talking about more than simple garbage collection. We are talking about a world where the run time is free to decide which garbage collection strategy it wants to use for a set of transformations based on the input/output or churn rate it can detect at run time ! Any sort of reclamation scheme like <a href="http://www.rdrop.com/users/paulmck/RCU/hart_ipdps06.pdf" target="_blank" rel="external">RCU</a>, <a href="http://concurrencykit.org/presentations/ebr.pdf" target="_blank" rel="external">EBR</a> or <a href="https://www.youtube.com/watch?v=aV-RyMXXuks" target="_blank" rel="external">anything else</a> we dream to fancy !</p>
<p>Moreover, the run time can not only decide the reclamation strategy but it can also decide the allocation strategy as well. If a particular transformation can be distributed it can decide to distribute that and scale it up or down based on a predetermined control strategy. Speaking of control theory we could get to a world where allocation and reallocation can be <a href="https://www.youtube.com/watch?v=B6vr1x6KDaY" target="_blank" rel="external">balanced</a> entirely on churn rate !</p>
<h2 id="Injecting-data-storage"><a href="#Injecting-data-storage" class="headerlink" title="Injecting data storage !"></a>Injecting data storage !</h2><p>Moreover, at any point in time, the data between our transformations can be <em>frozen</em> before it gets to our next transformations in the pipeline. Since we clearly know all the details we need to know about a particular data we can decide to <em>inject</em> stages in our pipeline where data is <em>frozen</em> before it gets to the next transformation in the pipeline. In our experience we found that all the issues you encounter in production are always due to these factors. Its either transport , storage or synchronizations issues. Sometimes you even get <em>lucky</em> and get all in a combo[1]. Rarely do you get issues because something was done wrongly in your <em>transformation/computation</em>. If something is wrong with your transformation it would be very easy to detect and catch it during your unit testing. The corollary to that is “If something fails in your transformation it basically means that you have a bad unit testing in place”!</p>
<p>Coming back to our storage story, data storage can also be done in memory. It does not have to obviously be in slow magnetic disks only. By virtue of us knowing everything about our data schema we can store the output of our transformation in memory in a sequential log oriented fashion that we can scream through to achieve maximum throughput. To quote <em>Martin Thompson</em> in <a href="https://youtu.be/fDGWWpHlzvw?t=1234" target="_blank" rel="external">Designing for Performance </a>: <strong>Memory systems are about 3 bets</strong></p>
<blockquote>
<ul>
<li>The temporal bet</li>
<li>The spatial bet</li>
<li>The striding bet</li>
</ul>
</blockquote>
<p>By rearranging or scheduling our transformations appropriately on the right cores and memory we can actually play to these bets !</p>
<h2 id="Injecting-data-transports"><a href="#Injecting-data-transports" class="headerlink" title="Injecting data transports !"></a>Injecting data transports !</h2><p>In the same way that our data can be stored in a multitude of fashions we can also decide to transport it in between our transformations with a transport that fits the bill for our particular application needs. If rest/http is a better fit for a transformation we can decide to adopt that. On the contrary if plain TCP is better we can decide to inject that in between our transformations. Any kind of transport that fits the bill can be <em>injected</em> here. It goes without saying that also mixing transports and picking and choosing the appropriate transports in an “a la carte” fashion is obviously possible.</p>
<p>The major thing we are doing here is delaying decisions about what kind of transport we will chose until we are ready to test the system is making us delay those concerns. Obviously we still have to deal with platform specific transports as well as all the errors that come with a distributed system but all we are saying here is lets decide to delay when we need to deal with those issues. Or more specifically lets turn them into something that the platform or run time or even the person deploying the system can decide for us and free us from those concerns altogether !</p>
<h2 id="Recap-please"><a href="#Recap-please" class="headerlink" title="Recap please ?"></a>Recap please ?</h2><p>Initially what we wanted was to focus on the actual data because at the end of the day data is our real problem !</p>
<blockquote>
<p>If you don’t understand the data you don’t understand the problem. <em>Mike Acton</em> <a href="https://www.youtube.com/watch?v=rX0ItVEVjHc" target="_blank" rel="external">“Data-Oriented Design and C++”</a></p>
</blockquote>
<p>Unfortunately, we found that every time we want to wire data transformations we have to also think upfront about what we consider as <em>avoidable concerns</em>. Everyone will agree that once you remove these concerns life becomes much easier. We can all agree that even if it is not going to be easy to implement our systems based solely on the idea of data transformations, at the very least, we can all agree that it is not something impossible to do. Who said this was not worth a shot ?</p>
<p>Or to put it differently: Let us all agree here on the benefits of <code>what</code> we need to accomplish in terms of simplifying our data transformations before talking about <code>how</code> we are going to accomplish that goal. It might take us few iterations to get it right but we think that this is more a <code>when</code> question than an <code>if</code> question .. so stay tuned for more !</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/10/09/2017/wiring-data-transformations-for-speed-02/" data-id="cj7hrk4vi00067egmsd2pazrx" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2017/wiring-data-transformations-for-speed-01" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/09/09/2017/wiring-data-transformations-for-speed-01/">Wiring data transformations for speed (part 1)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/09/09/2017/wiring-data-transformations-for-speed-01/">
            <time datetime="2017-09-09T15:00:00.000Z" itemprop="datePublished">2017-09-09</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/data-flow/">data flow</a>, <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/memory/">memory</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>If you think about our software industry today all we do , day in and day out, is “transform” data from one state to another. The systems we have in place today can be seen , at a very high level, as black boxes that take a variable number of arguments as inputs and produce a well defined output</p>
<blockquote>
<p>The purpose of all programs, and all parts of those programs, is to transform data from one form to another. <em>Mike Acton</em> <a href="https://youtu.be/rX0ItVEVjHc?t=757" target="_blank" rel="external">“Data-Oriented Design and C++”</a></p>
</blockquote>
<p>It is becoming intensely hard to keep focusing on that sentence when we are writing code these days. Instead, we fiddle and play with very complicated constructs that hide and obfuscate the true nature of what a program is supposed to do. It has become so revoltingly bad that not only can we not see the big picture from a high level view of the system we also cant even understand what the program is doing without a hefty amount of documentation and/or debugging !</p>
<p>In this article we will try to highlight some of the accidental complexities we introduce (knowingly or unknowingly) by writing code the way we do today.</p>
<h2 id="Going-back-to-compilers"><a href="#Going-back-to-compilers" class="headerlink" title="Going back to compilers"></a>Going back to compilers</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> </span>&#123;</div><div class="line">  <span class="keyword">long</span> aXb = multiply(<span class="number">2</span>, <span class="number">3</span>);</div><div class="line">  <span class="keyword">long</span> sum = add(<span class="number">1</span>, aXb);</div><div class="line">  System.out.println(<span class="string">"sum:"</span> +sum);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If you look at the above code you will see that all we are actually doing is moving data from one form to another. The <code>multiply</code> method takes a <code>{2,3}</code> tuple as input and outputs <code>6</code>. And the same is for the <code>add</code> Method. In fact if we feed this code to a compiler we will most likely end up with this data dependency graph</p>
<img src="/images/wiring-data-transformations-for-speed-001.png">
<p>Any compiler/jit worth its salt will actually collapse the above and turn it into a single literal inside the main function. But that is actually beside the point for now. All we want to show is the data dependency graph between the different code blocks. <rant mode=""></rant></p>
<p>The point we are trying to drive home is that the compiler is basically deconstructing what we gave to it into a data flow graph. Which begs the question: “Why did we push the compiler to make this translation?”. Unfortunately the answer lies in years of history. Wish explains why we keep writing code that represents a data flow graph but we keep expressing that graph in a very imperative (not to sat cumbersome) way and expect the compiler to go and figure what we actually mean. </p>
<p>Before we jump to the conclusion that maybe there is a better way of coding the above let us first understand how many decisions we made by just writing the above code. Yes it is indeed very easy to write but once we understand the cost of the implicit decisions we made by just writing the above code we can step back and ask ourselves why did we force ourselves into this ?</p>
<h2 id="Mutability-concurrency"><a href="#Mutability-concurrency" class="headerlink" title="Mutability/concurrency !"></a>Mutability/concurrency !</h2><p>The first implicit decision we made was a major one and it was about data ownership. Imagine if the data we were passing to the multiply method was not a simple literal but a large object or even to make things worse an array of objects ? Everything is passed by reference in java. As such you cannot attach arbitrary read/write capabilities to your objects at the time you are calling a method. If you want immutability you either have to use something like a guava library(with its Immutable.of saga) or make sure that the object you pass is actually an interface. Or even worst convert your primitives into their java objects counterparts which are guaranteed to be immutable! Which is a very hefty price to pay in terms of memory layout and even memory overhead. Basically your object have to be immutable at the time you are creating them ! But we want to stress that you have to know the trade offs of being immutable at a very early stage and stick to it. All developers are expected to know these common pitfalls and are supposed to deal with it …  ¯_(ツ)_/¯</p>
<p>As an alternative approach, actor oriented languages like pony’s <a href="https://www.ponylang.org/learn/#reference-capabilities" target="_blank" rel="external">Reference capabilities</a> have a way of cleanly solving these hard concurrency issues by defining what it calls a <em>path</em> towards a reference. Having a reference to an object is not enough. You can also specify not only what you are capable of doing with that reference but what you are not. Which i found very refreshing to say the least ! By virtue of being newer, languages like <a href="https://www.ponylang.org" target="_blank" rel="external">ponylang</a> do not adhere to the idiosyncrasies we learned to live with after years of development history. It remains that, for the majority of popular languages out there, the run time nor the type system is going to help unless one is ready to use tricks we mentioned above.</p>
<h2 id="Application-binary-interface"><a href="#Application-binary-interface" class="headerlink" title="Application binary interface !"></a>Application binary interface !</h2><p>Its worth noting that the compiler took a look at the above code and decided (or was hard coded to decide ) what the ABI was between the function calls. The compiler just “assumed” that we actually wanted to pass a couple of variables to a local function. That is why the compiler was able to optimize it and reason about it. Now this makes a lot of sense in the majority of cases where you just want the compiler to make something that can be easily inlined.</p>
<p>Unfortunately, there is no way to tell a compiler please turn this function call into a distributed function call and please make sure you take care about the endian-ness and/or other ugly (but still important) issues associated with that. Another example would be trying to call the same function but written in a different language via a different FFI (foreign function interface). Java FFI is called JNI and is a nightmare to work with in practice. Plus the fact that it only supports “C” like any other languages out there. Cross language FFI is not something you can do easily across all languages for now without being forced to go through our dear mighty “C”.</p>
<p>I know this is not necessarily what compilers are meant to support today. Most compiler writers will be happy to say “Thank you but no thank you” if you asked them to add features like the above. And they are probably right. A compiler is probably not the right place to do this. The point is that a compiler and the type system already know what we are passing as arguments between functions. Then why do we need a different way to again specify these same data structures so that they can be passed between languages and systems ? </p>
<p>If a you as a programmer wants to see if you can call a rest API just to make the multiply method work in a distributed fashion you have to actually call a distributed system expert and make sure you deal with all the error handling as well as which transport is the most adequate one to use. Not to mention the threading model Just for that simple question ! It would be nice if in 2017 we had a way to tap into a different way of designing programming languages so that cross language boundaries or even  system boundaries was more seamless!</p>
<h2 id="Threading-model"><a href="#Threading-model" class="headerlink" title="Threading model !"></a>Threading model !</h2><p>Which brings us to our next issue. The threading model ! By definition the compiler assumes that if you call a method you are most certainly trying to call it within the current threading model .. obviously !!! If you want to work around that perception then you have to explicitly code around it !</p>
<p>Now, we know from experience that writing multi threaded code is not for the faint of heart. Unfortunately everyone and their uncle wants to write multi threaded/concurrent code because simply there is no way around it. Neither the run time nor the compiler make it easy to construct something that will say please run this particular code in a different thread and please make that as seamless as possible. I am not saying its impossible. You can still achieve something that works. But it still takes a serious head spin every time you want to embark in that .. or you need to call an expert again!  </p>
<p>Someone will mention the ideas of go subroutines and how easy it is to work with them. Which can be applauded since this is a step in the right direction. It does however attest to the simple fact that we need something better than what we currently have. Meaning life could be much easier than this way of doing things. It is just error prone not to say completely brainless !</p>
<p>Somewhat related to the threading model is the notion of when a particular call to a function is going to be made. By definition a compiler will assume that what you want is to call that method immediately and you have to wait for the response. Meaning you have a blocking call automatically. It would be nice if we could execute that call asynchronously. Or to be even fancier switch to a blocking or non blocking call via a configuration flag and not decide that upfront.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We could go on an on about what is wrong with the current tooling and programming paradigms we have today. Unfortunately we would only be stating the problems ! What we wanted to highlight here was the inherent problems associated with the way we do things today before moving forward. And to quote our favourite speaker again:</p>
<blockquote>
<p>Solving problems you probably don’t have creates more problems you definitely do. <em>Mike Acton</em> <a href="https://youtu.be/rX0ItVEVjHc?t=846" target="_blank" rel="external">“Data-Oriented Design and C++”</a></p>
</blockquote>
<p>To be clear the point of this article was to show that at the very beginning we all start with a simple flow graph. The fact that we are coding that flow graph in an imperative way is not the root cause of all our issues. However, as soon as we are done coding that basic flow graph we are immediately faced , more like <em>forced</em>, to deal with the issues we highlighted above. And since we are so used to and prefer to solve everything with code we decided , maybe wrongly, that we should deal with those issues by using the exact same means we used to express our data flow graph ! And therein maybe lies our mistake!</p>
<p>Now here is an idea: Would it be nice if we could code our basic flow graph in the way we are used to today but take out all the accidental/surrounding complexities and deal with them outside our simple flow graph ? Do you think that would simplify things and maybe move it a ton faster ? And when we say faster we do not only mean faster in terms of code speed but we actually mean coding and delivery time as well !</p>
<p>If we have your attention then stay tuned for another article this is going to be a (somewhat) long ride !</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/09/09/2017/wiring-data-transformations-for-speed-01/" data-id="cj7hrk4vh00057egm6nsz0s9k" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2014/walking-down-memory-lane-03" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/06/10/2014/walking-down-memory-lane-03/">Walking down memory lane (part 3)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/06/10/2014/walking-down-memory-lane-03/">
            <time datetime="2014-10-06T04:00:00.000Z" itemprop="datePublished">2014-10-06</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/memory/">memory</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>If you remember our previous <a href="/2014/09/25/2014/walking-down-memory-lane-02">article</a> we used a central memory location to share data between two separate threads each running either in the same process or across separate processes. These processes could even be located on separate machine or even be written in two different languages.</p>
<img src="/images/walking-down-memory-lane-03-000.png" title="550px">
<p>From the above you can see that we only have one thread writing to the shared data. The other thread is only reading this shared data once it is notified that the data was correctly published by the writer thread. Now the question is how do these threads synchronize access to this shared memory location with minimal contention ?</p>
<h2 id="Lock-free-rings-to-the-rescue"><a href="#Lock-free-rings-to-the-rescue" class="headerlink" title="Lock free rings to the rescue"></a>Lock free rings to the rescue</h2><p>If we need to access this data concurrently we need to let the two separate threads agree (more like synchronize) access based on a locking mechanism. The trick here is to piggy back on the memory model provided by the processor. The cache coherency on x86 systems provides a happens-before guaranty when the data in a certain memory location is modified. However, if the memory is written using the <a href="https://mechanical-sympathy.blogspot.ca/2011/09/single-writer-principle.html" target="_blank" rel="external">Single Writer Principle</a> that data is not propagated forcibly each time a write occurs to invalidate other caches. This basically means that, If the publishing thread writes to this memory location the other thread(s)/core(s) will see this change at some time in the future (and anything that happened before it) without impeding or affecting the publishing thread. As such, the publishing thread can keep updating that location. For the gory details i will point you to this article on <a href="https://mechanical-sympathy.blogspot.ca/2013/02/cpu-cache-flushing-fallacy.html" target="_blank" rel="external">CPU Cache</a> and this one on <a href="https://mechanical-sympathy.blogspot.ca/2011/07/memory-barriersfences.html" target="_blank" rel="external">memory barriers and fences</a>.</p>
<img src="/images/walking-down-memory-lane-03-001.png" title="550px">
<p>As can be seen above the two threads behaviour looks, conceptually, like a reservoir with one thread filling it from the top while the other thread is draining it. The memory is treated as a single contiguous stream of data with each message having a unique incrementally sequential location. The reader thread knows that the messages coming down the pipe have the same size and are all numbered in a sequential manner and keeps track of the last message position that was fetched from the pipe (head). On the other hand, the publishing thread also knows the sequence number of the last message written to the pipe (tail). Both sequences are augmented incrementally and independently via lock free based mechanism. The algorithm for inserting new elements in this queue must enforce a limit since we only have a very finite space for storing things. Ergo the notion of a circular ring buffer. The writer thread needs to make sure no new elements are inserted when the circular ring buffer is full. On a similar note, the reader thread also makes sure that if there are no new elements added since the last fetch it can spin lock waiting for new elements to be inserted. This algorithm is said to be lock free but not necessarily wait free. Meaning that we can bail out and go do other things when the queue is full/empty , making thus the algorithm practically wait free, or if there is nothing else to do we can do a spin lock until the situation is resolved. Meaning we lose the wait free portion but we are still lock free. From a pedantic point of view an algorithm is called lock free when progress is guaranteed for the system as a whole but not necessarily for each thread.</p>
<p>One can easily imagine how this buffer can be seen by multiple reader threads with one single publisher making broadcast or parallel type messaging. It is only a matter of adding more head/tail addresses and managing that accordingly when we are adding/removing items in the queue. Once the messages are read by multiple consumer threads they can all act on the same data in a parallel fashion or each consumer thread can be responsible for only part of the sequences based on a partitioning scheme. One particular partitioning technique championed by the <a href="http://lmax-exchange.github.io/disruptor/" target="_blank" rel="external">Disruptor</a> is to use a modulo for each reader so that for example odd sequence messages are handled by one reader while the others are handled by another reader. But we still get the same benefits in that the actual data will be paged by the kernel and available right away without incurring unnecessary cache misses. Once a block of data is written to memory we could use something like transferTo to finally achieve a zero copy like network <a href="https://www.ibm.com/developerworks/linux/library/j-zerocopy/" target="_blank" rel="external">transfer</a> in Java while the publishing thread continues to write new data on a new location. the fact remains that each particular reader thread is effectively free to do what it pleases with the block of data without waiting or synchronizing with other threads.</p>
<p>Furthermore, as we said before, the consumer thread can be anything that can access this memory locations sequentially. This scheme can be used to not only communicate with lower level c/c++ code (or any code written in any language for that matter) but it can also be used to send data directly to GPUs running on the same machine. Once a sufficient amount of data is written by the thread publishing this block of data it can be copied over using DMA over the graphic processing card for example. The same obviously goes for sending/receiving data over high speed NIC cards or proprietary high speed transports.</p>
<h2 id="Lets-share-some-data"><a href="#Lets-share-some-data" class="headerlink" title="Lets share some data !"></a>Lets share some data !</h2><p>I uploaded the code for this article on <a href="https://github.com/yassinm/blog.mlane.000" target="_blank" rel="external">github</a>. The application is using shared memory mapped files for the memory location. When i run the publisher and subscriber for a 50Million 8 byte (long) one way message stream (from publisher to subscriber only) on a AWS m3.2xlarge instance i am consistently getting ~140 Million messages per second. The test is repeated for 30times and averaged. On my AMD 4 core laptop i am getting a mere 13M messages per second. This is before we start talking about thread affinity and cpu isolation. If you can run this code on your own hardware give me a shout!</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/06/10/2014/walking-down-memory-lane-03/" data-id="cj7hrk4vc00037egmkdki4mxt" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2014/walking-down-memory-lane-02" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/25/09/2014/walking-down-memory-lane-02/">Walking down memory lane (part 2)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/25/09/2014/walking-down-memory-lane-02/">
            <time datetime="2014-09-25T04:00:00.000Z" itemprop="datePublished">2014-09-25</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/memory/">memory</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>As per our previous <a href="/2014/09/21/2014/walking-down-memory-lane-01">article</a> we identified that we need a way to serialize objects into memory in a very efficient manner. To recap here is a picture showing the steps we need to remove when sending/receiving objects over the network.</p>
<img src="/images/walking-down-memory-lane-02-000.png" width="300">
<p>FTR we are still not interested in solving how these troublesome bytes are transferred over the network from one process to another once the data is ready to be transferred. For this article we are leaving this aspect aside and will only concentrate on efficiently storing those objects in memory and manipulating them correctly.</p>
<h2 id="Unsafe-relationships-with-data"><a href="#Unsafe-relationships-with-data" class="headerlink" title="Unsafe relationships with data"></a>Unsafe relationships with data</h2><p>Like we said earlier java has a dark side if you want to really start fiddling with bytes in an unsafe and unprotected manner. This is called (quite rightly) sun.misc.Unsafe. For the gory details i will refer you to this <a href="https://mechanical-sympathy.blogspot.ca/2012/07/native-cc-like-performance-for-java.html" target="_blank" rel="external">article</a>. What we gain immediately by using this unsafe method are :</p>
<p>We finally have a way of accessing bytes for read and writes purposes directly just like we used to in c/c++. We can also do so very efficiently and in a very high speed manner.<br>The code using these objects is not aware of what is happening behind the scene.<br>For the sake of cache coherency, it is much better to access the memory in a single stride fashion so that we are not jumping back and forth in memory.<br>Hiding behind an interface</p>
<h2 id="Hiding-behind-an-interface"><a href="#Hiding-behind-an-interface" class="headerlink" title="Hiding behind an interface"></a>Hiding behind an interface</h2><p>What we achieved, instantly, by using the “unsafe” method is a read/write through interface. The block of memory behind the object is effectively acting as a cache that we use to read/write behind the scene. The fact that we are dealing with unsafe is only an implementation specific issue. All the code using this interface is unaware of what is happening.</p>
<img src="/images/walking-down-memory-lane-02-001.png">
<p>This effectively means that the memory backing these objects could come from anywhere in the system ! We are not limited by the limitations of heap memory and its cumbersome garbage collection schemes. The gates are open for an infinite amount of unmanaged off-heap memory ! In fact, we are not even limited by the memory available on the process altogether. We could use a shared memory scheme where all the data could be read/written by a separate locally running process. Or for that matter anything that was published by the kernel in a memory location somewhere on the system !!! As long as we can address the memory in a progressive single stride fashion we can effectively address anything located locally or somewhere else on the universe. More on this later …</p>
<h2 id="Sharing-is-messaging"><a href="#Sharing-is-messaging" class="headerlink" title="Sharing is messaging !"></a>Sharing is messaging !</h2><p>As we said above the memory that is living behind the proxy object could also be a shared memory location. As long as we take care of how we are accessing these memory locations concurrently we can effectively send messages between local threads running within the same process !</p>
<img src="/images/walking-down-memory-lane-02-002.png" title="[40%] height=100%">
<p>In the same vein it is not a big stretch to see how this technique could be applied to threads running across a multitude of processes running within the same machine or running on different geographically located data centres as part of a big cluster. It is only a matter of making sure the objects see the exact same data copied verbatim across those process boundaries. The biggest technical hurdle that is left to overcome is the synchronization mechanism we will use to make sure we are accessing these objects safely. Of course it will also have to be a very fast synchronization mechanism or we will lose the benefit of doing all these magical memory fiddling contraptions!</p>
<p>Furthermore, if we keep accessing memory with the Single Writer Principle in mind we might be able to share this memory location with more than one reader in a non contention based fashion. To quote that page ‘On x86/x64 loads can be re-ordered with older stores according to the memory model so memory barriers are required when multiple threads mutate the same data across cores. The single writer principle avoids this issue because it never has to deal with writing the latest version of a data item that may have been written by another thread and currently in the store buffer of another core”. But let us not go ahead of ourself here, we are not there yet !</p>
<p>One thing that you (maybe) missed to notice is that i completely ignored talking about how we were going to turn our objects to memory bytes via the serialization step which we set out to fix in the beginning of this article. As you can see that step is unnecessary since the code using our fine grained fly weight proxy object is directly reading and writing to the bytes locations. As such, when the user code calls the set functions on the proxy object we are technically performing the serialization to memory right away. Vice versa, when the user calls the get functions available on the proxy object they are effectively de-serializing the object from memory. All of the above is done efficiently and with minimal locking involved … Et voila !</p>
<h2 id="Do-you-know-the-memory-man-the-memory-man-who-lives-on-Drury-Lane"><a href="#Do-you-know-the-memory-man-the-memory-man-who-lives-on-Drury-Lane" class="headerlink" title="Do you know the memory man ? the memory man ? who lives on Drury Lane ?"></a>Do you know the memory man ? the memory man ? who lives on Drury Lane ?</h2><p>Now one more little titbit remaining is that the process or thread we are sharing our data with does not have to be written in java at all. It could be written in any language binding that can use our proxy object. It can be in Java,c#,c/c++,erlang, ruby,nodejs, python , php … you name it. It just does not matter at all. Like we said before ,for all intents and purposes , it could be coming from the kernel itself. As long as the memory representation and location is followed we can both communicate over this high speed channel. Imagine a world where you could write your database access in Java and your number crunching in c/c++. And they could be both living within the same process or across from two separate data centers !</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>We started with solving a simple serialization/de-serialization problem and we are already talking about fixing the inherent communication problems when people want to mix code written for different platforms and with different languages without sacrificing performance. I would say that this side effect is a very beautiful addition to solving our original problem(s). Assuming it works out … obviously !</p>
<p>Until we get there i can always say that “I have a dream … I have a dream that one day down in a process — with its vicious language base discrimination , with its OS having its lips dripping with the words of interposition and nullification — one day right there in a process, little java boys and c# girls will be able to join hands with little c/c++ boys and ruby girls as sisters and brothers. I have a dream that one day every valley shall be exalted, and every hill and mountain shall be made low. The rough places will be plain and the crooked places will be made straight, and the glory of all languages shall be revealed”</p>
<p>So stay tuned for that dream to come true !</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/25/09/2014/walking-down-memory-lane-02/" data-id="cj7hrk4vk00077egmdrqbnnok" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2014/walking-down-memory-lane-01" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/21/09/2014/walking-down-memory-lane-01/">Walking down memory lane (part 1)</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/21/09/2014/walking-down-memory-lane-01/">
            <time datetime="2014-09-21T04:00:00.000Z" itemprop="datePublished">2014-09-21</time>
        </a>
    </div>


                        
                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/java/">java</a>, <a class="tag-link" href="/tags/memory/">memory</a>
    </div>

                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            <p>One of the topics that you often have to deal with in java, especially in high performance and low latency distributed code, is how you send a set of objects to a worker thread in the most efficient manner. This thread could be running in the same process or on a completely separate machine located somewhere else in your network. This has always been the case for people coming from a c/c++ environment even before the advent of Java. However, Java has steadily gained so much in performance and JIT improvements over the years that nowadays it is on par , in some areas, with c/c++. This of course does not come free and requires a very careful design and a very good understanding of current IPC mechanisms. Moreover, some of the new techniques involving Off-heap memory allocations and lock free queues can even go further. As always, the devil is in the details. In this post i will try to first look at how you can pass data efficiently between different threads/processes and the different issues we have to solve when dealing with the java language.</p>
<h2 id="Serializing-de-serializing"><a href="#Serializing-de-serializing" class="headerlink" title="Serializing/de-serializing"></a>Serializing/de-serializing</h2><p>If you want to pass around a block of memory in c/c++ all you need to do on the receiving side is cast the actual memory location to a particular structure and you immediately get an object you can play with. At your own risk of course! This scenario is similar to having all your belts off while driving a formula one vehicle and going the wrong way on a high speed lane … Other cars coming at you being the data that was sent to you. This is why you can refer to this practice as having “unsafe” relations with your data! On the flip side, this does not mean the code receiving the data has to be running within the same process. It could be running somewhere else in the universe as long as the actual data was transported successfully! You still have to take care of the normal Endian-ness of the platform, which is obviously also needed in Java, but that is all that’s required. Technically speaking, there is no need for serialization/de-serialization required since the actual objects are already in bytes format. Unfortunately, we do not have the luxury of these dangerous “Shoot my own feet features” practices in Java. That is, unless you turn yourself into the dark side by using the famously unsafe using sun.misc.Unsafe ! More on this later …</p>
<p>In java , when you pass objects around between threads within the same process you can get away by only passing the reference to the actual object. Obviously, you will have to take great care when the passed object is accessed concurrently across the multiple threads in your process. You can deal with issues like this by implementing one of the concurrent access mechanisms available in the JVM. The problem however comes when your target thread is running in a separate process. In that scenario you need a way of serializing/de-serializing the objects before and after they hit the wire. This ,dealing with objects back and forth, becomes very cumbersome suddenly.</p>
<p>The above additional complexity stems from the fact that we do not have (yet) a way to deal with arrays of structures in java as we do in c/c++. We basically can’t have “unsafe” relations with our data. All objects , including arrays of all types, are passed by reference. As such these objects must all live in the heap and are all susceptible for garbage collection. This basically means that anything you get from the wire has to be “transformed” into actual objects before they are ready for consumption. Lately, the growing majority experience this aspect in Java when dealing with Restful services. An object is first serialized into JSON , sent over the wire via a transport protocol, and then de-serialized when it arrives at its destination before it is passed to the upper application specific code. The simpler the object the easier it is to perform those steps and the faster the overall code becomes. I will not bore you with the multiple technologies available in that arena but i will point you to this comparison.</p>
<h2 id="Memory-control"><a href="#Memory-control" class="headerlink" title="Memory control"></a>Memory control</h2><p>Unfortunately, there is no particular way one can instruct the JVM on how objects are stored and how they are placed in memory in contiguous or non contiguous fashion. As far as the general programmer is concerned these pesky details are what make the platform “safe”. As such, these details are considered irrelevant for the majority of use cases. This is exactly why it is not needed for a lot of users. The exception is when your code needs to deal with performance critical access to very large amount of objects and you need to have a good control on how these particular objects are stored in memory efficiently. .</p>
<p>Furthermore, the access pattern across different threads and cores accessing the actual fields in your objects can also be problematic. False sharing explained here and here is a very good case on why it is important to know your memory layout in a performance critical code. Again this is not for everyone! But you can still see why it is imperative to understand the concepts involved when you need to write performance critical code.</p>
<p>To make things even more complicated there is no “traditional” way in Java on how you access bytes directly as soon as they are off the network in a zero copy fashion. Once you get data in a NIC buffer the application has to go through a context switch before data is available in user land. The same thing happens when the bytes are on their way out. There are commercial libraries/hardware to do these but so far this not part of the things available out of the box and definitely not for “free” !</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>You would think that someone has already worked out the details for most of these issues and came up with a clean and simplistic way , ala Corba style, for you to send data across different threads/processes and with high speed. Fortunately there are some outstanding libraries out there we will explore in our next articles, but you still have to understand these complexities yourself and you still need to be in the know. Ergo, the need for this first part covering the basics!</p>
<p>To conclude i will say that we need to figure a way to:</p>
<p>Turn objects to bytes (and vice versa) in a very high speed fashion<br>Make sure we have a good control on how the memory is been used even in java.<br>The above outlines only some of the issues i can think of right now. To me these issues constitute a list of requirements i would want my high speed serializing/de-serializing code to deal with. Do i hear a future framework in java in the horizon that would solve (most of) these issues … that’s a “definite maybe” so stay tuned!</p>

        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/21/09/2014/walking-down-memory-lane-01/" data-id="cj7hrk4v900027egm0nczm23s" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>



    <article id="post-2013/first-post" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        
            <header class="article-header">
                
    
        <h1 itemprop="name">
            <a class="article-title" href="/13/07/2013/first-post/">Starting to blog ... finally</a>
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/13/07/2013/first-post/">
            <time datetime="2013-07-13T04:00:00.000Z" itemprop="datePublished">2013-07-13</time>
        </a>
    </div>


                        
                        
                    </div>
                
            </header>
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
            
        
        </div>
        <footer class="article-footer">
            <div class="share-container">



</div>

    <a data-url="http://yoursite.com/13/07/2013/first-post/" data-id="cj7hrk4v500017egmvfib54yy" class="article-share-link"><i class="fa fa-share"></i>Share</a>
<script>
    (function ($) {
        // Prevent duplicate binding
        if (typeof(__SHARE_BUTTON_BINDED__) === 'undefined' || !__SHARE_BUTTON_BINDED__) {
            __SHARE_BUTTON_BINDED__ = true;
        } else {
            return;
        }
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="fa fa-twitter article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="fa fa-facebook article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="fa fa-pinterest article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="fa fa-google article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

            
    

        </footer>
    </div>
    
</article>


</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">recent</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/10/09/2017/wiring-data-transformations-for-speed-02/" class="thumbnail">
    
    
        <span style="background-image:url(/images/wiring-data-transformations-for-speed-002.png)" alt="Wiring data transformations for speed (part 2)" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/10/09/2017/wiring-data-transformations-for-speed-02/" class="title">Wiring data transformations for speed (part 2)</a></p>
                            <p class="item-date"><time datetime="2017-09-10T15:00:00.000Z" itemprop="datePublished">2017-09-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/09/09/2017/wiring-data-transformations-for-speed-01/" class="thumbnail">
    
    
        <span style="background-image:url(/images/wiring-data-transformations-for-speed-001.thumb.png)" alt="Wiring data transformations for speed (part 1)" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/09/09/2017/wiring-data-transformations-for-speed-01/" class="title">Wiring data transformations for speed (part 1)</a></p>
                            <p class="item-date"><time datetime="2017-09-09T15:00:00.000Z" itemprop="datePublished">2017-09-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/06/10/2014/walking-down-memory-lane-03/" class="thumbnail">
    
    
        <span style="background-image:url(/images/walking-down-memory-lane-03-000.png)" alt="Walking down memory lane (part 3)" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/06/10/2014/walking-down-memory-lane-03/" class="title">Walking down memory lane (part 3)</a></p>
                            <p class="item-date"><time datetime="2014-10-06T04:00:00.000Z" itemprop="datePublished">2014-10-06</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/25/09/2014/walking-down-memory-lane-02/" class="thumbnail">
    
    
        <span style="background-image:url(/images/walking-down-memory-lane-02-000.png)" alt="Walking down memory lane (part 2)" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/25/09/2014/walking-down-memory-lane-02/" class="title">Walking down memory lane (part 2)</a></p>
                            <p class="item-date"><time datetime="2014-09-25T04:00:00.000Z" itemprop="datePublished">2014-09-25</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/21/09/2014/walking-down-memory-lane-01/" class="thumbnail">
    
    
        <span class="thumbnail-image thumbnail-none"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"></p>
                            <p class="item-title"><a href="/21/09/2014/walking-down-memory-lane-01/" class="title">Walking down memory lane (part 1)</a></p>
                            <p class="item-date"><time datetime="2014-09-21T04:00:00.000Z" itemprop="datePublished">2014-09-21</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">tags</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/data-flow/">data flow</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/memory/">memory</a><span class="tag-list-count">5</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">archives</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">October 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a><span class="archive-list-count">1</span></li></ul>
        </div>
    </div>

    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2017 Yassin Mohamed<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        


    
    
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>